<html>
<head>
    <title>Logo.JS</title>
    <style>
        .errorText { 
            color: red;
        }

        .consoleText {
            color : black;
            font-family:Courier, monospace;
            overflow-y: auto;
            height: 100px;
            border: 1px solid black;
        }
        
        button {
            color: #090909;
            padding: 0.7em 1.7em;
            font-size: 18px;
            border-radius: 0.5em;
            background: #e8e8e8;
            border: 1px solid #e8e8e8;
            transition: all .3s;
            box-shadow: 6px 6px 12px #c5c5c5,
                        -6px -6px 12px #ffffff;
        }

        button:active {
            color: #666;
            box-shadow: inset 4px 4px 12px #c5c5c5,
                        inset -4px -4px 12px #ffffff;
        }

        body{
            font-family: arial;	
        }

        .drawingArea {
            height : 38vh;
            width:100%;
            border:1px solid black;
            overflow-y:scroll;
            border-radius: 6px;
        }

        .drawingSVG {
            height : 1000px;
            width : 100%;
        }

        .wrapper{
            width: 99vw;
            height: 45vh;
            
            
            display: flex;
            align-items: stretch;
            justify-content: left;
        }

        .cmd{
            position: relative;
            display: block;
            
            /* height: 600px; */
            height: 40vh;
            width: 100%;
            border: 1px solid #000000;
            border-radius: 4px;
            overflow: hidden;
            
            box-shadow: 0px 8px 18px #4b1d3f;
        }

        /*
        * 1. Set position
        * 2. Set dimension
        * 3. Style
        */
        .title-bar{
            /* 1 */
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            /* 2 */
            width: 100%;
            height: 40px;
            /* 3 */
            display: block;
            color: #FFFFFF;
            line-height: 40px;
            font-weight: 600;
            background-color: #242424;
            text-align: left;
        }

        .textarea{
            position: relative;
            top: 40px;
            padding: 12px;
            
            resize: none;
            width: 100%;
            height: calc(100%);
            background-color: #4b1d3f;
            border: none;
            color: #FFFFFF;
            margin: 0px;
            font-size: 1.1rem;
        }


    </style>
    <script src="./node_modules/monaco-editor/min/vs/loader.js"></script>
    
    <script src="./main.js"></script>
<script>

    const DEFAULT_STARTING_X = 100;
    const DEFAULT_STARTING_Y = 100;
    const DEFAULT_STARTING_ANGLE = 270;
    const DEFAULT_VARIANT = 'english_terse'

    var runner;
    var variant = DEFAULT_VARIANT

    function init()
    {
        let params = new URLSearchParams(window.location.search);
        let startX = params.get("x") || DEFAULT_STARTING_X;
        let startY = params.get("y") || DEFAULT_STARTING_Y;
        let startAngle = params.get("angle") || DEFAULT_STARTING_ANGLE;
        variant = params.get('variant') || DEFAULT_VARIANT;
        
        let drawingBoard = document.getElementById('drawing')
        let editorParent = document.getElementById('editorContainer')
        initEditor()
        runner = main.initApp(drawingBoard,startX,startY,startAngle,showMsg,editorParent)
    }

    var editor = null;

    function configLangInEditor(monaco)
    {
        monaco.languages.register({ id: 'logojs' });
        monaco.languages.setMonarchTokensProvider('logojs',{
            // monaco.languages.setLanguageConfiguration('logojs',{
            // Set defaultToken to invalid to see what you do not tokenize yet
            // defaultToken: 'invalid',

            keywords: [
                'fd', 'rt', 'repeat', 'end', 'procedure', 'let', 'if', 'else', 'while', 'true', 'false',
                'bk','lt','pc','pd','pu','call','then', 'say','with'
            ],

            typeKeywords: [
                'number'
            ],

            operators: [
                '=', '>', '<', '==', '<=', '>=', '=/=',
                '+', '-', '*', '/', '%'
            ],

            // we include these common regular expressions
            symbols:  /[=><!~?:&|+\-*\/\^%]+/,

            // C# style strings
            escapes: /\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,

            // The main tokenizer for our languages
            tokenizer: {
                root: [
                // identifiers and keywords
                [/[a-z_$][\w$]*/, { cases: { '@typeKeywords': 'keyword',
                                            '@keywords': 'keyword',
                                            '@default': 'identifier' } }],
                [/[A-Z][\w\$]*/, 'type.identifier' ],  // to show class names nicely

                // whitespace
                { include: '@whitespace' },

                // delimiters and operators
                [/[{}()\[\]]/, '@brackets'],
                [/[<>](?!@symbols)/, '@brackets'],
                [/@symbols/, { cases: { '@operators': 'operator',
                                        '@default'  : '' } } ],

                
                // numbers
                [/\d*\.\d+([eE][\-+]?\d+)?/, 'number.float'],
                // [/0[xX][0-9a-fA-F]+/, 'number.hex'],
                [/\d+/, 'number'],

                // delimiter: after number because of .\d floats
                [/[;:]/, 'delimiter'],

                // strings
                [/"([^"\\]|\\.)*$/, 'string.invalid' ],  // non-teminated string
                [/'/,  { token: 'string.quote', bracket: '@open', next: '@string' } ],

                // characters
                [/'[^\\']'/, 'string'],
                //   [/(')(@escapes)(')/, ['string','string.escape','string']],
                [/'/, 'string.invalid']
                ],

                comment: [
                [/[^\/*]+/, 'comment' ],
                [/\/\*/,    'comment', '@push' ],    // nested comment
                ["\\*/",    'comment', '@pop'  ],
                [/[\/*]/,   'comment' ]
                ],

                string: [
                [/[^\\']+/,  'string'],
                //   [/@escapes/, 'string.escape'],
                [/\\./,      'string.escape.invalid'],
                [/'/,        { token: 'string.quote', bracket: '@close', next: '@pop' } ]
                ],

                whitespace: [
                [/[ \t\r\n]+/, 'white'],
                [/\/\*/,       'comment', '@comment' ],
                [/\/\/.*$/,    'comment'],
                ],
            },
        })
    }

    function initEditor()
    {
        require.config({ paths: { vs: './node_modules/monaco-editor/min/vs' } });

        require(['vs/editor/editor.main'], function () {
            configLangInEditor(monaco)
             editor = monaco.editor.create(document.getElementById('editorContainer'), {
                value: 'fd 100;',
                language: 'logojs',
                theme:'vs-dark'
            });
        });
    }

    function parseAndExecuteProgram()
    {
        try
        {
            clearError()
            let code = editor && editor.getValue()
            let program = main.parseCode(code,variant);
            runner.run(program);
        }
        catch (err)
        {
            showError(err.toString())
        }
    }

    function showMsg(msg)
    {
        let m = msg || '';//TODO: clean input message - escape html
        console.log(m)
        document.getElementById('cons').innerHTML += m + "<br/>"
    }

    function showError(msg)
    {
        console.error(msg || '')
        document.getElementById("error").innerText = `${msg || ""}`
    }
    function clearError()
    {
        document.getElementById("error").innerText = ""
    }

    function clearConsole()
    {
        document.getElementById('cons').innerText = ''
    }

    function reset()
    {
        main.resetState();
        clearError()
        clearConsole();
    }

    function clearDrawing()
    {
        runner.empty();
    }

</script>
</head>

<body onload="init()">

    <div id="drawing" class="drawingArea"></div>
    <hr/>
    <div class="wrapper">
        <div class="cmd" id="editorContainer">
        </div>
    </div>
    <button onclick="parseAndExecuteProgram()"> Execute </button>
    <button onclick="reset()">Reset</button>
        <hr/>
    <div id="cons" class="consoleText" ></div>
    <span id="error" class="errorText" ></span>
    
</body>
</html>